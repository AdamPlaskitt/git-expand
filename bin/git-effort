#!/usr/bin/env bash

ABOVE=0
while test $# -gt 0;
do
    case "$1" in
        --above)
            shift
            if test $# -gt 0;
            then
                ABOVE=$1
            else
                echo "No limit set"
                exit
            fi
            shift
            ;;
        *)
        break
        ::
    esac
done

max=0

# Get the dates related to a file
dates() {
    git log --pretty='format: %ad' $file | sed 's/ ... //g' | sed 's/:..:..//g' | sed 's/ +.*//g'
}

# Get the commits for a file
commits() {
    dates | awk '
    { sum += 1 }
    END { print sum }
  '
}

# Get the active hours for a file
active_hours() {
    dates | uniq | awk '
    { sum += 1 }
    END { print sum }
  '
}


files="$(git ls-files | HEAD -n10)" # Get files
for file in $files
do
    # Add row to data
    if [ ${#file} -ge $max ]
    then
        max=${#file}
    fi
done

# Get the length of the max row plus 5
len=$((max + 5))
# Output
printf "  %-${len}s %-10s %s\n" 'path' 'commits' 'active hours'

for file in $files
do
    total_commits=$(commits)
    if [ $total_commits -ge $ABOVE ]
    then
        printf "  %-${len}s %-10s %s\n" ${file} ${total_commits} $(active_hours)
    fi
done
